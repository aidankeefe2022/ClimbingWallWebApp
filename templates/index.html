<!DOCTYPE html>
<html lang="en">
<script src="https://unpkg.com/htmx.org@2.0.4" integrity="sha384-HGfztofotfshcF7+8n44JQL2oJmowVChPTg48S+jvZoztPfvwD79OC/LTtG6dMp+" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
<script>
    let myChartInstance = undefined;

    function clearFields() {
        document.getElementById('name').value = "";
        document.getElementById('color').value = "";
        // If you want to reset the dropdown to its first option:
        document.getElementById('grade').value = "";
    }

    async function updateChart() {
        let resp = await fetch('/chartInfo', {method: 'GET'})
        let data = await resp.json()
        console.log(data)
        let keys = Object.keys(data)
        let values = Object.values(data)
        let maxValue = Math.max(...values)

        const ctx = document.getElementById("myChart").getContext('2d');

        if (myChartInstance) {
            myChartInstance.destroy();
        }

        myChartInstance =  new Chart(ctx, {
              type: "bar",
              data: {
                labels: keys,
                datasets: [{
                  backgroundColor: '#B9975B',
                  data: values
                }]
              },
            options: {
                scales: {
                  y: {
                      beginAtZero: true,
                      min: 0,
                      max: maxValue + 1, // sets the max to 1 above the highest bar
                      ticks:{
                        stepSize: 1
                      }
                  }
                }
            }
        });
    }

    document.addEventListener("DOMContentLoaded", function() {
        updateChart();
        // Listen for the HTMX afterRequest event
        document.body.addEventListener('htmx:afterRequest', () => {
            updateChart()
            clearFields()
        })


    });
</script>

<head>
    <meta charset="UTF-8">
    <title>CLIMB</title>
</head>
<body style="background-color: #030b29;">
<div class="relative overflow-x-auto shadow-md sm:rounded-lg">
<div class="flex flex-row">
    <div class="w-1/2 relative overflow-x-auto shadow-md sm:rounded-lg space-y-4 mt-4">
        <form class="max-w-sm mx-auto" hx-post="/insert" hx-swap="innerHTML" hx-target="#tb" method="POST"  hx-on::afterRequest="clearFields(); updateChart()">
            <div>
              <label for="name" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Name</label>
               <input type="text" id="name" name="name" class="block w-full p-2 text-gray-900 border border-gray-300 rounded-lg bg-gray-50 text-xs focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500">
          </div>
            <div>
              <label for="color" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Color</label>
              <input type="text" id="color" name="color" class="block w-full p-2 text-gray-900 border border-gray-300 rounded-lg bg-gray-50 text-xs focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500">
          </div>
            <div>
              <label for="setter" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Setter</label>
              <select id="setter" name="setter" class="block w-full p-2 text-gray-900 border border-gray-300 rounded-lg bg-gray-50 text-xs focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500">
                  <option value="Aidan">Aidan</option>
                  <option value="Nome">Nome</option>
                  <option value="Sam">Sam</option>
              </select>
          </div>
            <div>
              <label for="grade" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Grade</label>
              <input type="text" id="grade" name="grade" class="block w-full p-2 text-gray-900 border border-gray-300 rounded-lg bg-gray-50 text-xs focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500">
          </div>
             <div class="flex space-y-4 mt-4">
              <input  type="submit" value="Add" id="small-input" class="block w-full p-2 text-gray-900 border border-gray-300 rounded-lg bg-gray-50 text-xs focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500">
          </div>
        </form>
    </div>
<div class="w-1/2">
    <canvas id="myChart" style="width:100%;max-width:700px;max-height:400px"></canvas>
</div>
</div>



<div class="relative shadow-md sm:rounded-lg position:sticky">
    <table class="w-full text-sm text-left rtl:text-right text-gray-500 dark:text-gray-400 space-y-4 mt-4">
        <thead class="text-xs text-gray-700 uppercase dark:text-gray-400 position:sticky top:0 max-hieght">
            <tr>
                <th scope="col" class="px-6 py-3 bg-gray-50 dark:bg-gray-800">
                    Name
                </th>
                <th scope="col" class="px-6 py-3">
                    Color
                </th>
                <th scope="col" class="px-6 py-3 bg-gray-50 dark:bg-gray-800">
                    Setter
                </th>
                <th scope="col" class="px-6 py-3">
                    Grade
                </th>
                <th scope="col" class="px-6 py-3">
                    Delete
                </th>
            </tr>
        </thead>
        <tbody id="tb">
            {%  for item in data %}
            <tr>
                <th scope="row" class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap bg-gray-50 dark:text-white dark:bg-gray-800">
                    {{ item.name }}
                </th>
                <td class="px-6 py-4">
                    {{ item.color }}
                </td>
                <td class="px-6 py-4 bg-gray-50 dark:bg-gray-800">
                    {{ item.setter }}
                </td>
                <td class="px-6 py-4">
                    {{ item.grade }}
                </td>
                <td class="px-6 py-4 bg-gray-50 dark:bg-gray-800">
                    <button class="focus:outline-none text-white bg-red-700 hover:bg-red-800 focus:ring-4 focus:ring-red-300 font-medium rounded-lg text-sm px-5 py-2.5 me-2 mb-2 dark:bg-red-600 dark:hover:bg-red-700 dark:focus:ring-red-900" hx-delete="\delete" hx-target="#tb" hx-vals='{"id":{{ item.id }}}'>Delete</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

</div>
</body>
</html>